version: 2
models:
  - name: int_jaffle_data__customer_order_history
    columns:
      - name: customer_id
        data_tests:
          - unique
          - not_null

      - name: total_orders
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1
              strictly: false

      - name: total_spent
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: false

      - name: avg_order_value
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: false

      - name: first_order_date
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2016-09-01'"
              max_value: "{{ current_timestamp() }}"

      - name: last_order_date
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2017-01-08'"
              max_value: "{{ current_timestamp() }}"

      - name: customer_lifetime_days
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: false

      - name: customer_segment
        data_tests:
          - not_null
          - accepted_values:
              values: ['VIP', 'Regular', 'New']
          - dbt_expectations.expect_column_values_to_be_in_set:
              value_set: ['VIP', 'Regular', 'New']

    data_tests:
      - dbt_expectations.expect_table_row_count_to_equal:
          value: 930
      - dbt_expectations.expect_table_columns_to_match_ordered_list:
          column_list: ['customer_id', 'total_orders', 'total_spent', 'avg_order_value', 'first_order_date', 'last_order_date', 'customer_lifetime_days', 'customer_segment']

    unit_tests:
      - name: test_customer_order_history_segments
        model: int_jaffle_data__customer_order_history
        given:
          - input: ref('int_jaffle_data__order_items')
            rows:
              - {customer_id: 1, order_id: 101, ordered_at: '2023-01-10', product_price: 1500}
              - {customer_id: 1, order_id: 102, ordered_at: '2023-02-15', product_price: 2000}
              - {customer_id: 2, order_id: 201, ordered_at: '2023-03-10', product_price: 800}
          - input: ref('stg_jaffle_data__customers')
            rows:
              - {id: 1, name: 'John'}
              - {id: 2, name: 'Jane'}
        expect:
          rows:
            - {customer_id: 1, total_orders: 2, total_spent: 3500, avg_order_value: 1750, customer_segment: 'Regular'}
            - {customer_id: 2, total_orders: 1, total_spent: 800, avg_order_value: 800, customer_segment: 'New'}