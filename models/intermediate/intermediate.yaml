version: 2

models:
  - name: int_jaffle_data__customer_order_history
    columns:
      - name: customer_id
        data_tests:
          - unique
          - not_null
      - name: total_orders
        data_tests:
          - not_null
      - name: total_spent
        data_tests:
          - not_null
      - name: avg_order_value
        data_tests:
          - not_null
      - name: first_order_date
        data_tests:
          - not_null
      - name: last_order_date
        data_tests:
          - not_null
      - name: customer_lifetime_days
        data_tests:
          - not_null
      - name: customer_segment
        data_tests:
          - not_null
          - accepted_values:
              values: ['VIP', 'Regular', 'New']

  - name: int_jaffle_data__order_items
    columns:
      - name: order_id
        data_tests:
          - not_null
      - name: customer_id
        data_tests:
          - not_null
      - name: ordered_at
        data_tests:
          - not_null
      - name: store_id
      - name: sku
        data_tests:
          - not_null
      - name: product_name
        data_tests:
          - not_null
      - name: product_type
      - name: product_price
        data_tests:
          - not_null
      - name: customer_order_seq
        data_tests:
          - not_null
      - name: previous_product_type

unit_tests:
  - name: test_customer_order_history_segments
    model: int_jaffle_data__customer_order_history
    given:
      - input: ref('int_jaffle_data__order_items')
        rows:
          - {customer_id: 1, order_id: 101, ordered_at: '2023-01-10', product_price: 1500}
          - {customer_id: 1, order_id: 102, ordered_at: '2023-02-15', product_price: 2000}
          - {customer_id: 2, order_id: 201, ordered_at: '2023-03-10', product_price: 800}
      - input: ref('stg_jaffle_data__customers')
        rows:
          - {id: 1, name: 'John'}
          - {id: 2, name: 'Jane'}
    expect:
      rows:
        - {customer_id: 1, total_orders: 2, total_spent: 3500, avg_order_value: 1750, customer_segment: 'Regular'}
        - {customer_id: 2, total_orders: 1, total_spent: 800, avg_order_value: 800, customer_segment: 'New'}

  - name: test_order_items_data_integrity
    model: int_jaffle_data__order_items
    given:
      - input: ref('stg_jaffle_data__orders')
        rows:
          - {id: 101, customer_id: 1, ordered_at: '2023-01-10', store_id: 1}
          - {id: 102, customer_id: 1, ordered_at: '2023-02-15', store_id: 1}
          - {id: 201, customer_id: 2, ordered_at: '2023-03-10', store_id: 2}
      - input: ref('stg_jaffle_data__items')
        rows:
          - {order_id: 101, sku: 'SKU001'}
          - {order_id: 102, sku: 'SKU002'}
          - {order_id: 201, sku: 'SKU003'}
      - input: ref('stg_jaffle_data__products')
        rows:
          - {sku: 'SKU001', name: 'Product A', type: 'Type A', price: 1500}
          - {sku: 'SKU002', name: 'Product B', type: 'Type B', price: 2000}
          - {sku: 'SKU003', name: 'Product C', type: 'Type C', price: 800}
    expect:
      rows:
        - {order_id: 101, customer_id: 1, ordered_at: '2023-01-10', store_id: 1, product_price: 1500}
        - {order_id: 102, customer_id: 1, ordered_at: '2023-02-15', store_id: 1, product_price: 2000}
        - {order_id: 201, customer_id: 2, ordered_at: '2023-03-10', store_id: 2, product_price: 800}
